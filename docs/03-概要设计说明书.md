# CineSeek 概要设计说明书

## 文档信息

| 项目名称 | CineSeek - 电影信息搜索系统 |
|---------|---------------------------|
| 文档版本 | 1.0 |
| 编写日期 | 2025-11-02 |
| 编写人 | 开发团队 |
| 审核人 | 项目负责人 |

## 1. 引言

### 1.1 编写目的

本文档描述 CineSeek 系统的概要设计,包括系统架构、模块划分、接口设计等,为详细设计和开发提供指导。

### 1.2 项目背景

CineSeek 是一款基于 Wikidata 和 Wikipedia 的电影信息搜索系统,采用前后端分离架构,为用户提供快速准确的电影信息查询服务。

### 1.3 参考资料

- CineSeek 业务需求说明书 v1.0
- CineSeek 需求规格说明书 v1.0
- FastAPI 官方文档
- Vue 3 官方文档
- Wikidata Query Service 文档

## 2. 系统总体设计

### 2.1 系统架构

CineSeek 采用**前后端分离**的三层架构:

```
┌─────────────────────────────────────────────────────────┐
│                    表示层(Presentation)                   │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │   Vue 3 Frontend (SPA)                         │    │
│  │  - App.vue (主组件)                             │    │
│  │  - 搜索界面                                     │    │
│  │  - 结果展示                                     │    │
│  │  - 历史管理                                     │    │
│  └────────────────────────────────────────────────┘    │
│                        ↕ HTTP/JSON                      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                   业务逻辑层(Business Logic)              │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │   FastAPI Backend                              │    │
│  │  ┌──────────────────────────────────────┐     │    │
│  │  │  API Layer (api.py)                  │     │    │
│  │  │  - /api/search                       │     │    │
│  │  │  - /search                           │     │    │
│  │  │  - /api/health                       │     │    │
│  │  └──────────────────────────────────────┘     │    │
│  │  ┌──────────────────────────────────────┐     │    │
│  │  │  Parser Module (parser.py)           │     │    │
│  │  │  - parse_title()                     │     │    │
│  │  │  - guessit 集成                       │     │    │
│  │  │  - 正则解析降级                       │     │    │
│  │  └──────────────────────────────────────┘     │    │
│  │  ┌──────────────────────────────────────┐     │    │
│  │  │  Provider Module (providers/)        │     │    │
│  │  │  - wikidata.py                       │     │    │
│  │  │  - search_movies()                   │     │    │
│  │  │  - SPARQL 查询                        │     │    │
│  │  └──────────────────────────────────────┘     │    │
│  │  ┌──────────────────────────────────────┐     │    │
│  │  │  Models (models.py)                  │     │    │
│  │  │  - MovieResult                       │     │    │
│  │  │  - MovieResultExtended               │     │    │
│  │  │  - SearchRequest                     │     │    │
│  │  └──────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────┘    │
│                        ↕ SPARQL/HTTP                    │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                   数据层(Data Layer)                      │
│                                                          │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  Wikidata   │  │  Wikipedia   │  │  Wikimedia   │  │
│  │   SPARQL    │  │   Articles   │  │   Commons    │  │
│  └─────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                   本地存储(Client Storage)                │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │   localStorage                                 │    │
│  │  - cineseek_search_history                     │    │
│  └────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

#### 2.2.1 前端技术栈

| 技术 | 版本 | 用途 |
|-----|------|------|
| Vue | 3.x | 前端框架 |
| Vite | 5.x | 构建工具 |
| JavaScript | ES6+ | 编程语言 |
| CSS3 | - | 样式设计 |
| Fetch API | - | HTTP 请求 |

#### 2.2.2 后端技术栈

| 技术 | 版本 | 用途 |
|-----|------|------|
| Python | 3.10+ | 编程语言 |
| FastAPI | 0.100+ | Web 框架 |
| Pydantic | 2.x | 数据验证 |
| httpx | 0.24+ | HTTP 客户端 |
| guessit | 3.x | 文件名解析 |
| OpenCC | 1.x | 繁简转换 |
| uvicorn | 0.23+ | ASGI 服务器 |

### 2.3 部署架构

```
┌─────────────────────────────────────────────────────────┐
│                      用户浏览器                           │
│                    (Chrome/Firefox/...)                  │
└──────────────────────────┬──────────────────────────────┘
                           │ HTTPS
                           ↓
┌─────────────────────────────────────────────────────────┐
│                      Nginx (可选)                         │
│              - 反向代理                                   │
│              - 静态文件服务                               │
│              - HTTPS 终止                                │
└──────────┬───────────────────────────┬──────────────────┘
           │                           │
           │ 静态资源                   │ API 请求
           ↓                           ↓
┌──────────────────┐        ┌────────────────────────────┐
│  静态文件服务器   │        │   FastAPI 应用服务器        │
│  (Nginx/Apache)  │        │   - Uvicorn                │
│  - index.html    │        │   - FastAPI App            │
│  - *.js/*.css    │        │   - Port: 8000             │
└──────────────────┘        └────────────┬───────────────┘
                                         │
                                         │ SPARQL/HTTP
                                         ↓
                            ┌────────────────────────────┐
                            │   外部服务                  │
                            │  - Wikidata SPARQL         │
                            │  - Wikipedia               │
                            │  - Wikimedia Commons       │
                            └────────────────────────────┘
```

## 3. 模块设计

### 3.1 后端模块划分

#### 3.1.1 API 模块(api.py)

**职责**: 提供 HTTP API 接口,处理客户端请求

**主要功能**:
- 接收和验证 HTTP 请求
- 调用业务逻辑模块
- 返回格式化的 JSON 响应
- CORS 中间件配置

**接口列表**:
| 接口 | 方法 | 说明 |
|-----|------|------|
| / | GET | 首页 |
| /api/health | GET | 健康检查 |
| /search | GET | 兼容接口(单结果) |
| /api/search | POST | 搜索接口(多结果) |

#### 3.1.2 解析器模块(parser.py)

**职责**: 解析电影文件名,提取电影名称和年份

**主要功能**:
- 使用 guessit 库进行智能解析
- 正则表达式降级解析
- 噪声标记过滤
- 年份提取和验证
- 括号内容处理
- 繁简体处理

**核心函数**:
```python
def parse_title(raw: str) -> Tuple[str, Optional[int]]
```

#### 3.1.3 数据提供者模块(providers/wikidata.py)

**职责**: 与 Wikidata 交互,搜索电影信息

**主要功能**:
- 构建 SPARQL 查询
- 执行 HTTP 请求
- 解析 SPARQL 响应
- 获取海报 URL
- 获取维基百科链接
- 繁简转换搜索
- 错误处理和重试

**核心函数**:
```python
async def search_movies(
    title: str,
    limit: int = 10,
    extended: bool = False
) -> List[Union[MovieResult, MovieResultExtended]]
```

#### 3.1.4 数据模型模块(models.py)

**职责**: 定义数据结构和验证规则

**主要类**:
- `SearchRequest`: 搜索请求模型
- `MovieResult`: 基础电影结果模型
- `MovieResultExtended`: 扩展电影结果模型

### 3.2 前端模块划分

#### 3.2.1 主组件(App.vue)

**职责**: 应用主界面,包含所有功能

**组成部分**:
```
<template>
  ├─ 顶部标题区
  ├─ 搜索区
  │  ├─ 输入框
  │  ├─ 搜索按钮
  │  └─ 历史面板
  ├─ 错误提示区
  ├─ 结果展示区
  │  └─ 电影卡片(循环)
  │     ├─ 海报图片
  │     ├─ 标题
  │     ├─ 类型标签
  │     ├─ 国家标签
  │     └─ 维基百科链接
  └─ 底部信息
</template>

<script>
  ├─ 响应式状态管理
  ├─ 搜索逻辑
  ├─ 历史管理
  └─ 事件处理
</script>

<style>
  └─ 组件样式
</style>
```

**核心功能**:
- 搜索请求发送
- 结果数据展示
- 历史记录管理
- 用户交互处理

#### 3.2.2 样式模块(assets/style.css)

**职责**: 全局样式定义

**内容**:
- 基础样式重置
- 通用组件样式
- 响应式布局
- 主题配色

## 4. 数据库设计

CineSeek 系统**不使用传统数据库**,采用以下数据存储策略:

### 4.1 外部数据源

- **Wikidata**: 存储电影元数据
- **Wikipedia**: 提供词条链接
- **Wikimedia Commons**: 存储海报图片

### 4.2 客户端存储

- **localStorage**: 存储搜索历史(最多 10 条)

```javascript
// 存储格式
{
  "cineseek_search_history": [
    "White House Down 2013",
    "Inception",
    "阿凡达 2009",
    ...
  ]
}
```

## 5. 接口设计

### 5.1 前后端接口

#### 5.1.1 POST /api/search

**请求**:
```json
{
  "query": "White.House.Down.2013.1080p.BluRay.x264"
}
```

**响应**:
```json
[
  {
    "wikidata_id": "Q227429",
    "title_cn": "惊天危机",
    "title_en": "White House Down",
    "year": 2013,
    "display_title": "惊天危机 White House Down (2013)",
    "genres": ["动作", "惊悚"],
    "countries": ["美国"],
    "poster_url": "https://...",
    "wikipedia_links": {
      "zh": "https://zh.wikipedia.org/wiki/...",
      "en": "https://en.wikipedia.org/wiki/..."
    }
  }
]
```

#### 5.1.2 GET /search?keyword={query}

**请求参数**:
- keyword: 搜索关键词

**响应**: MovieResult 对象或空字符串

### 5.2 后端与外部服务接口

#### 5.2.1 Wikidata SPARQL 接口

**端点**: https://query.wikidata.org/sparql

**请求方式**: GET/POST

**查询示例**:
```sparql
SELECT DISTINCT ?item ?itemLabel ?year ?titleCN ?titleEN 
WHERE {
  ?item wdt:P31 wd:Q11424 .  # 实例是电影
  
  {
    ?item rdfs:label ?titleCN .
    FILTER(LANG(?titleCN) = "zh" && REGEX(?titleCN, "盗梦空间", "i"))
  } UNION {
    ?item rdfs:label ?titleEN .
    FILTER(LANG(?titleEN) = "en" && REGEX(?titleEN, "Inception", "i"))
  }
  
  OPTIONAL { ?item wdt:P577 ?publicationDate . }
  SERVICE wikibase:label { bd:serviceParam wikibase:language "zh,en" . }
}
LIMIT 10
```

**响应格式**: JSON

## 6. 运行环境

### 6.1 开发环境

**后端**:
- Python 3.10+
- uv 包管理器
- 虚拟环境(.venv)

**前端**:
- Node.js 16+
- npm 8+
- Vite 开发服务器(端口 5173)

**后端服务器**:
- Uvicorn(端口 8000)

### 6.2 生产环境

**服务器要求**:
- CPU: 2 核心+
- 内存: 2GB+
- 存储: 1GB+
- 操作系统: Linux/Windows/macOS

**网络要求**:
- 需要访问 Wikidata SPARQL 服务
- 需要访问 Wikipedia
- 需要访问 Wikimedia Commons

## 7. 安全性设计

### 7.1 CORS 策略

**开发环境**:
```python
allow_origins=["*"]  # 允许所有来源
```

**生产环境**:
```python
allow_origins=["https://cineseek.example.com"]  # 限制域名
```

### 7.2 输入验证

- 搜索关键词长度限制: 1-500 字符
- 特殊字符过滤
- SQL 注入防护(使用 Pydantic 验证)

### 7.3 错误处理

- 不暴露服务器内部错误信息
- 返回友好的错误提示
- 记录错误日志供排查

### 7.4 速率限制

- 未来考虑: API 速率限制
- 防止恶意请求和 DDoS 攻击

## 8. 性能设计

### 8.1 异步处理

- 使用 FastAPI 异步特性
- HTTP 请求使用 httpx 异步客户端
- 避免阻塞操作

### 8.2 缓存策略

**客户端缓存**:
- 海报图片浏览器缓存
- 搜索结果短期缓存(未来考虑)

**服务器缓存**:
- 未来考虑: Redis 缓存热门搜索结果

### 8.3 超时控制

- Wikidata 查询超时: 15 秒
- HTTP 请求超时: 30 秒
- 前端请求超时: 30 秒

### 8.4 并发控制

- FastAPI 支持高并发
- 异步 I/O 处理多个请求
- 目标: 支持 100+ 并发请求

## 9. 可靠性设计

### 9.1 容错机制

**解析器降级**:
```
guessit 可用 → 使用 guessit
     ↓ 失败
正则表达式解析
```

**外部服务容错**:
- Wikidata 不可用 → 返回友好错误
- 海报获取失败 → 使用占位图
- 网络超时 → 返回部分结果

### 9.2 错误恢复

- 自动重试机制(HTTP 请求)
- 降级策略(解析器)
- 优雅降级(海报、链接等可选信息)

### 9.3 日志记录

- 记录关键操作
- 记录错误和异常
- 性能监控日志

## 10. 可维护性设计

### 10.1 代码组织

```
backend/
  src/cineseek/
    __init__.py
    api.py          # API 路由
    parser.py       # 解析器
    models.py       # 数据模型
    cli.py          # 命令行工具
    providers/
      __init__.py
      wikidata.py   # Wikidata 提供者

frontend/
  src/
    App.vue         # 主组件
    main.js         # 入口文件
    assets/
      style.css     # 全局样式
```

### 10.2 配置管理

**后端配置**:
- CORS 设置
- 超时设置
- 日志级别

**前端配置**:
- API 基础 URL(环境变量)
- `.env.development`: 开发环境配置

### 10.3 版本控制

- Git 版本控制
- 语义化版本号(SemVer)
- 变更日志记录

## 11. 扩展性设计

### 11.1 数据源扩展

**当前**: Wikidata

**未来可扩展**:
- TMDB API
- OMDb API
- 豆瓣电影(如可用)

**扩展方式**:
```python
# providers/tmdb.py
async def search_movies(title, limit):
    # TMDB 实现
    pass
```

### 11.2 功能扩展

**当前功能**: 电影搜索

**可扩展功能**:
- 电视剧搜索
- 纪录片搜索
- 演员信息查询
- 批量处理 API
- 用户收藏功能

### 11.3 国际化

**当前**: 中英文支持

**可扩展语言**:
- 日语
- 韩语
- 法语
- 西班牙语

## 12. 部署方案

### 12.1 开发部署

```bash
# 后端
cd backend
uv sync
uv run uvicorn cineseek.api:app --reload

# 前端
cd frontend
npm install
npm run dev
```

### 12.2 生产部署

#### 方案 1: 传统部署

```bash
# 后端
cd backend
uv run uvicorn cineseek.api:app --host 0.0.0.0 --port 8000

# 前端
cd frontend
npm run build
# 将 dist/ 部署到 Nginx
```

#### 方案 2: Docker 部署(未来)

```dockerfile
# Dockerfile
FROM python:3.10-slim
WORKDIR /app
COPY backend/ .
RUN pip install uv && uv sync
CMD ["uvicorn", "cineseek.api:app", "--host", "0.0.0.0"]
```

## 13. 附录

### 13.1 关键技术选型理由

| 技术 | 选型理由 |
|-----|---------|
| FastAPI | 现代、快速、支持异步、自动文档生成 |
| Vue 3 | 轻量、易用、响应式、组件化 |
| Wikidata | 开放数据源、数据丰富、免费使用 |
| guessit | 专业的媒体文件名解析库 |
| Pydantic | 强大的数据验证、类型安全 |

### 13.2 架构设计原则

1. **关注点分离**: 前后端分离、模块化设计
2. **开放封闭原则**: 易于扩展、核心逻辑稳定
3. **依赖倒置**: 依赖抽象而非具体实现
4. **单一职责**: 每个模块职责明确
5. **高内聚低耦合**: 模块内部高内聚、模块间低耦合

---

**文档状态**: ✅ 已完成  
**最后更新**: 2025-11-02  
**版本历史**: v1.0 - 初始版本
