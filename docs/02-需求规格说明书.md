# CineSeek 需求规格说明书

## 文档信息

| 项目名称 | CineSeek - 电影信息搜索系统 |
|---------|---------------------------|
| 文档版本 | 1.0 |
| 编写日期 | 2025-11-02 |
| 编写人 | 开发团队 |
| 审核人 | 项目负责人 |

## 1. 引言

### 1.1 编写目的

本文档详细描述 CineSeek 电影信息搜索系统的功能需求规格,为开发、测试、验收提供依据。

### 1.2 项目背景

随着数字媒体库的普及,用户面临大量带有复杂编码信息的电影文件名,需要一个能够智能解析并快速获取准确电影信息的工具。现有的商业 API 往往需要付费或有调用限制,因此基于开放数据源(Wikidata/Wikipedia)的解决方案具有重要价值。

### 1.3 定义、首字母缩写词和缩略语

| 术语 | 说明 |
|-----|------|
| Wikidata | 维基媒体基金会的开放知识图谱数据库 |
| SPARQL | RDF 查询语言 |
| guessit | Python 媒体文件名解析库 |
| OpenCC | 中文繁简转换库 |
| TMDB | The Movie Database,商业电影数据库 API |
| API | Application Programming Interface |
| REST | Representational State Transfer |
| CORS | Cross-Origin Resource Sharing |

### 1.4 参考资料

- IEEE Std 830-1998: IEEE Recommended Practice for Software Requirements Specifications
- Wikidata Query Service 文档
- FastAPI 官方文档
- Vue 3 官方文档

## 2. 产品概述

### 2.1 产品视角

CineSeek 是一个独立的 Web 应用系统,采用前后端分离架构:
- **后端**: FastAPI + Python,提供 RESTful API
- **前端**: Vue 3 + Vite,提供 Web 用户界面
- **数据源**: Wikidata SPARQL 服务、Wikipedia、Wikimedia Commons

### 2.2 产品功能

核心功能包括:
1. 智能文件名解析
2. 电影信息搜索
3. 年份智能过滤
4. 繁简体转换搜索
5. 海报图片获取
6. 搜索历史管理
7. 维基百科链接提供

### 2.3 用户类和特征

| 用户类型 | 特征 | 权限 |
|---------|------|------|
| 普通用户 | 查询电影信息 | 搜索、查看结果 |
| 开发者 | 集成 API 到应用中 | 调用所有 API 接口 |

### 2.4 运行环境

**客户端环境**:
- 操作系统: Windows 10+、macOS 11+、Linux
- 浏览器: Chrome 90+、Firefox 88+、Safari 14+、Edge 90+
- 网络: 需要互联网连接

**服务器环境**:
- 操作系统: Linux、Windows、macOS
- Python: 3.10+
- 内存: 建议 ≥ 2GB
- 存储: ≥ 1GB
- 网络: 需要访问 Wikidata、Wikipedia 服务

### 2.5 设计和实现约束

1. **技术栈约束**:
   - 后端必须使用 FastAPI 框架
   - 前端必须使用 Vue 3 框架
   - 数据源限定为 Wikidata/Wikipedia

2. **性能约束**:
   - API 响应时间 < 3 秒(90%)
   - 支持至少 100 并发请求

3. **安全约束**:
   - 不存储用户隐私信息
   - 使用 HTTPS(生产环境)

## 3. 功能需求

### 3.1 智能文件名解析(FR-001)

#### 3.1.1 需求描述

系统应能够从包含复杂技术标记的电影文件名中提取核心电影名称和年份信息。

#### 3.1.2 输入

| 输入项 | 数据类型 | 说明 | 示例 |
|-------|---------|------|------|
| 文件名 | String | 用户输入的电影文件名 | `White.House.Down.2013.1080p.BluRay.x264` |

#### 3.1.3 处理

1. **优先使用 guessit 库解析**:
   - 调用 `guessit()` 函数
   - 提取 `title` 和 `year` 字段
   - 处理可能的多段标题

2. **降级到正则表达式解析**(guessit 失败时):
   - 提取括号内的年份信息
   - 移除所有括号内容
   - 使用分隔符切分字符串
   - 过滤常见噪声标记
   - 提取年份(1900-2100)
   - 合并剩余 token 为片名

3. **噪声标记列表**:
```
1080p, 2160p, 720p, 480p, 4k, 8k, webrip, web-dl, webdl, 
hdr, hdr10, dv, dolby, vision, x264, x265, h264, h265, 
hevc, avc, bluray, bdrip, brrip, remux, dvdrip, dts, 
dts-hd, truehd, atmos, aac, flac, mp3, dual, audio, 
multi, subs, multisub, nf, netflix, imax, remastered, 
extended, theatrical
```

#### 3.1.4 输出

| 输出项 | 数据类型 | 说明 |
|-------|---------|------|
| 电影名称 | String | 清洗后的电影名称 |
| 年份 | Integer/None | 提取的年份,如无则为 None |

#### 3.1.5 功能需求

| 需求ID | 需求描述 | 优先级 |
|-------|---------|-------|
| FR-001-01 | 系统应能识别常见的分辨率标记(1080p、720p 等)并过滤 | 高 |
| FR-001-02 | 系统应能识别常见的编码格式(x264、h265 等)并过滤 | 高 |
| FR-001-03 | 系统应能从括号中提取年份 | 高 |
| FR-001-04 | 系统应支持中英文混合文件名 | 高 |
| FR-001-05 | 当 guessit 不可用或失败时,系统应降级到正则解析 | 高 |
| FR-001-06 | 系统应能处理年份紧密连接中文的情况(如"变形金刚2007") | 中 |
| FR-001-07 | 系统应能识别和移除发行组标记(PublicHD、ETRG 等) | 中 |

#### 3.1.6 测试用例

| 用例ID | 输入 | 预期输出 |
|-------|------|---------|
| TC-001-01 | `White.House.Down.2013.1080p.BluRay.x264` | 名称: `White House Down`, 年份: `2013` |
| TC-001-02 | `变形金刚2007.1080p.BluRay.x264` | 名称: `变形金刚`, 年份: `2007` |
| TC-001-03 | `我是传奇(蓝光国英双音轨...).I.Am.Legend.2007.2160p.HDR` | 名称: `我是传奇` 或 `I Am Legend`, 年份: `2007` |
| TC-001-04 | `Inception.2010.IMAX.2160p.HDR10.x265` | 名称: `Inception`, 年份: `2010` |
| TC-001-05 | `阿凡达 (2009)` | 名称: `阿凡达`, 年份: `2009` |

### 3.2 电影信息搜索(FR-002)

#### 3.2.1 需求描述

基于解析出的电影名称,在 Wikidata 中搜索匹配的电影条目并返回详细元数据。

#### 3.2.2 输入

| 输入项 | 数据类型 | 说明 |
|-------|---------|------|
| 电影名称 | String | 解析后的电影名称 |
| 年份 | Integer/None | 可选的年份信息 |
| 结果数量限制 | Integer | 最多返回的结果数量(默认 10) |
| 扩展信息 | Boolean | 是否返回扩展信息(海报、链接等) |

#### 3.2.3 处理

1. **构建 SPARQL 查询**:
   - 搜索中文标题(P1476 + zh)
   - 搜索英文标题(P1476 + en)
   - 搜索别名(P2561)
   - 使用繁简转换扩展搜索范围
   - 限制实例类型为电影(Q11424)

2. **执行查询**:
   - 向 Wikidata SPARQL 服务发送请求
   - 超时时间: 15 秒
   - 处理可能的网络错误

3. **结果处理**:
   - 解析 SPARQL 响应
   - 提取基础字段:标题、年份、类型、国家
   - 如需要扩展信息,获取海报和维基百科链接
   - 格式化为统一数据结构

#### 3.2.4 输出

**基础结果(MovieResult)**:
```json
{
  "fullname": "盗梦空间 Inception",
  "name": "盗梦空间",
  "originalName": "Inception",
  "year": 2010,
  "genre": "科幻, 动作, 惊悚",
  "country": "美国, 英国",
  "alias": "Inception, インセプション"
}
```

**扩展结果(MovieResultExtended)**:
```json
{
  "wikidata_id": "Q25188",
  "title_cn": "盗梦空间",
  "title_en": "Inception",
  "year": 2010,
  "display_title": "盗梦空间 Inception (2010)",
  "genres": ["科幻", "动作", "惊悚"],
  "countries": ["美国", "英国"],
  "poster_url": "https://commons.wikimedia.org/...",
  "wikipedia_links": {
    "zh": "https://zh.wikipedia.org/wiki/盗梦空间",
    "en": "https://en.wikipedia.org/wiki/Inception"
  }
}
```

#### 3.2.5 功能需求

| 需求ID | 需求描述 | 优先级 |
|-------|---------|-------|
| FR-002-01 | 系统应能搜索中文电影标题 | 高 |
| FR-002-02 | 系统应能搜索英文电影标题 | 高 |
| FR-002-03 | 系统应能搜索电影别名 | 中 |
| FR-002-04 | 系统应支持繁简体自动转换搜索 | 中 |
| FR-002-05 | 系统应返回电影的年份、类型、国家等元数据 | 高 |
| FR-002-06 | 系统应能获取电影海报 URL | 中 |
| FR-002-07 | 系统应提供维基百科词条链接 | 低 |
| FR-002-08 | 系统应处理 Wikidata 服务不可用的情况 | 高 |
| FR-002-09 | 系统应在 15 秒内返回结果或超时 | 高 |

#### 3.2.6 异常处理

| 异常场景 | 处理方式 |
|---------|---------|
| Wikidata 服务不可用 | 返回错误信息,提示用户稍后重试 |
| 查询超时 | 返回已获取的部分结果或空结果 |
| 网络错误 | 返回友好错误信息 |
| 无搜索结果 | 返回空列表 |
| SPARQL 查询错误 | 记录错误日志,返回空结果 |

### 3.3 年份过滤(FR-003)

#### 3.3.1 需求描述

当解析出年份信息时,对搜索结果进行智能过滤和排序,提高匹配准确度。

#### 3.3.2 处理逻辑

1. **年份匹配判断**:
   ```python
   if result.year and abs(result.year - target_year) <= 1:
       # 匹配成功
   ```

2. **结果过滤**:
   - 如果有年份匹配的结果,仅保留年份匹配的结果
   - 如果没有年份匹配的结果,保留所有结果

3. **结果排序**:
   ```python
   results.sort(key=lambda r: abs((r.year or 0) - year) if r.year else 999)
   ```

#### 3.3.3 功能需求

| 需求ID | 需求描述 | 优先级 |
|-------|---------|-------|
| FR-003-01 | 系统应允许 ±1 年的误差范围 | 高 |
| FR-003-02 | 系统应优先返回年份精确匹配的结果 | 高 |
| FR-003-03 | 系统应按年份匹配度排序 | 高 |
| FR-003-04 | 当无年份匹配时,系统应返回所有结果 | 中 |

#### 3.3.4 测试用例

| 用例ID | 输入年份 | 结果年份列表 | 预期输出 |
|-------|---------|------------|---------|
| TC-003-01 | 2010 | [2010, 2009, 2011, 2008] | [2010, 2009, 2011] |
| TC-003-02 | 2010 | [2008, 2012, 2015] | [2008, 2012, 2015] (保留所有) |
| TC-003-03 | 2010 | [2010, 2010, 2009] | [2010, 2010, 2009] |

### 3.4 搜索历史管理(FR-006)

#### 3.4.1 需求描述

记录用户的搜索历史,提供快速重复搜索功能,支持历史管理。

#### 3.4.2 数据存储

- **存储方式**: localStorage
- **存储键**: `cineseek_search_history`
- **数据格式**: JSON 数组
- **最大数量**: 10 条

#### 3.4.3 功能需求

| 需求ID | 需求描述 | 优先级 |
|-------|---------|-------|
| FR-006-01 | 系统应在页面加载时从 localStorage 读取历史 | 高 |
| FR-006-02 | 系统应在搜索成功后自动添加到历史 | 高 |
| FR-006-03 | 系统应对搜索词去重,相同词不重复记录 | 高 |
| FR-006-04 | 系统应将最新搜索置于列表顶部 | 高 |
| FR-006-05 | 系统应限制最多保存 10 条历史记录 | 中 |
| FR-006-06 | 系统应提供清除所有历史的功能 | 中 |
| FR-006-07 | 系统应在输入框获得焦点时显示历史面板 | 中 |
| FR-006-08 | 系统应在点击外部时关闭历史面板 | 低 |
| FR-006-09 | 系统应支持点击历史项快速搜索 | 高 |

#### 3.4.4 操作流程

1. **添加历史**:
   ```
   1. 搜索成功
   2. 从列表中移除相同记录(如存在)
   3. 插入到列表开头
   4. 如超过 10 条,删除最后的记录
   5. 保存到 localStorage
   ```

2. **清除历史**:
   ```
   1. 用户点击"清除"按钮
   2. 清空历史数组
   3. 更新 localStorage
   4. 关闭历史面板
   ```

3. **选择历史**:
   ```
   1. 用户点击历史项
   2. 填充搜索框
   3. 关闭历史面板
   4. 执行搜索
   ```

### 3.5 API 接口定义

#### 3.5.1 健康检查

**接口**: `GET /api/health`

**描述**: 检查 API 服务状态

**响应**:
```json
{
  "ok": true
}
```

#### 3.5.2 电影搜索(兼容接口)

**接口**: `GET /search?keyword={query}`

**描述**: 兼容旧版接口,返回单个最佳匹配结果

**参数**:
| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| keyword | String | 是 | 搜索关键词 |

**响应**: `MovieResult` 对象或空字符串

#### 3.5.3 电影搜索(前端接口)

**接口**: `POST /api/search`

**描述**: 返回多个搜索结果,包含扩展信息

**请求体**:
```json
{
  "query": "White House Down 2013"
}
```

**响应**: `MovieResultExtended[]` 数组(最多 5 个)

## 4. 非功能需求

### 4.1 性能需求

| 需求ID | 需求描述 | 指标 |
|-------|---------|------|
| NFR-001 | API 响应时间 | < 3 秒(90% 请求) |
| NFR-002 | 并发处理能力 | ≥ 100 并发请求 |
| NFR-003 | Wikidata 查询超时 | 15 秒 |
| NFR-004 | 前端首屏加载 | < 2 秒 |
| NFR-005 | 海报图片加载 | 懒加载,不阻塞页面 |

### 4.2 可靠性需求

| 需求ID | 需求描述 | 指标 |
|-------|---------|------|
| NFR-006 | 系统可用性 | ≥ 99% |
| NFR-007 | 错误恢复 | 自动降级(guessit 失败时) |
| NFR-008 | 数据完整性 | 确保返回数据格式一致 |

### 4.3 可用性需求

| 需求ID | 需求描述 |
|-------|---------|
| NFR-009 | 界面应简洁直观,用户无需培训即可使用 |
| NFR-010 | 搜索失败时应提供友好的错误提示 |
| NFR-011 | 支持键盘快捷操作(Enter 搜索) |
| NFR-012 | 支持移动设备访问,响应式布局 |

### 4.4 兼容性需求

| 需求ID | 需求描述 |
|-------|---------|
| NFR-013 | 支持 Chrome 90+、Firefox 88+、Safari 14+、Edge 90+ |
| NFR-014 | 支持 Windows、macOS、Linux 操作系统 |
| NFR-015 | 后端支持 Python 3.10+ |

### 4.5 安全性需求

| 需求ID | 需求描述 |
|-------|---------|
| NFR-016 | 开发环境 CORS 允许所有来源,生产环境限制域名 |
| NFR-017 | 对用户输入进行基本验证,防止注入攻击 |
| NFR-018 | 不存储用户隐私信息 |
| NFR-019 | 生产环境使用 HTTPS 协议 |

### 4.6 可维护性需求

| 需求ID | 需求描述 |
|-------|---------|
| NFR-020 | 代码应遵循 PEP 8(Python)和 Vue 3 风格指南 |
| NFR-021 | 关键函数应有文档字符串 |
| NFR-022 | 应记录关键操作日志 |
| NFR-023 | 核心功能测试覆盖率 ≥ 80% |

## 5. 数据需求

### 5.1 数据字典

#### MovieResult
| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| fullname | String | 是 | 完整名称(中英文组合) |
| name | String | 是 | 中文名称 |
| originalName | String | 是 | 英文原名 |
| year | Integer | 是 | 年份 |
| genre | String | 否 | 类型(逗号分隔) |
| country | String | 否 | 制片国家/地区(逗号分隔) |
| alias | String | 否 | 又名(逗号分隔) |

#### MovieResultExtended
| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| wikidata_id | String | 否 | Wikidata ID(如 Q25188) |
| title_cn | String | 否 | 中文标题 |
| title_en | String | 否 | 英文标题 |
| year | Integer | 否 | 年份 |
| display_title | String | 是 | 组合显示标题 |
| genres | Array[String] | 是 | 类型列表 |
| countries | Array[String] | 是 | 国家列表 |
| poster_url | String | 否 | 海报 URL |
| wikipedia_links | Object | 是 | 维基百科链接(zh/en) |

#### SearchRequest
| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| query | String | 是 | 搜索关键词 |

### 5.2 数据约束

1. 年份范围: 1900-2100
2. 搜索关键词长度: 1-500 字符
3. 返回结果数量: 最多 5 个(前端接口)
4. 历史记录数量: 最多 10 条

## 6. 外部接口需求

### 6.1 Wikidata SPARQL 接口

- **URL**: https://query.wikidata.org/sparql
- **方法**: GET/POST
- **超时**: 15 秒
- **格式**: JSON

### 6.2 Wikipedia API

- **中文**: https://zh.wikipedia.org/wiki/{title}
- **英文**: https://en.wikipedia.org/wiki/{title}

### 6.3 Wikimedia Commons

- **图片URL**: 通过 Wikidata P18 属性获取

## 7. 质量属性

### 7.1 可测试性

- 所有核心功能应有对应的单元测试
- API 接口应有集成测试
- 提供测试数据集

### 7.2 可扩展性

- 模块化设计,便于添加新的数据源
- 支持添加新的解析规则
- 可扩展到其他媒体类型(电视剧、纪录片等)

### 7.3 可移植性

- 使用标准 Python 和 JavaScript
- 避免平台特定的代码
- 支持容器化部署(Docker)

## 8. 附录

### 8.1 需求追溯矩阵

| 业务需求 | 功能需求 | 优先级 |
|---------|---------|-------|
| 智能解析文件名 | FR-001 | 高 |
| 电影信息搜索 | FR-002 | 高 |
| 年份过滤 | FR-003 | 高 |
| 繁简转换 | FR-004 | 中 |
| 海报获取 | FR-005 | 中 |
| 搜索历史 | FR-006 | 中 |
| 多结果展示 | FR-007 | 高 |
| 维基百科链接 | FR-008 | 低 |

### 8.2 变更历史

| 版本 | 日期 | 变更内容 | 变更人 |
|-----|------|---------|-------|
| 1.0 | 2025-11-02 | 初始版本 | 开发团队 |

---

**文档状态**: ✅ 已完成  
**最后更新**: 2025-11-02  
**审核状态**: 待审核
