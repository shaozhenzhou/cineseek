# CineSeek 接口设计说明书

## 文档信息

| 项目名称 | CineSeek - 电影信息搜索系统 |
|---------|---------------------------|
| 文档版本 | 1.0 |
| 编写日期 | 2025-11-02 |
| 编写人 | 开发团队 |
| 审核人 | 项目负责人 |

## 1. 引言

### 1.1 编写目的

本文档详细描述 CineSeek 系统所有的 API 接口,包括请求格式、响应格式、错误处理等,为前端开发和第三方集成提供参考。

### 1.2 接口概述

CineSeek 提供 RESTful API,使用 JSON 格式进行数据交换。所有接口采用 UTF-8 编码。

**API 基础信息**:
- **基础 URL**: `http://127.0.0.1:8000` (开发环境)
- **协议**: HTTP/HTTPS
- **数据格式**: JSON
- **字符编码**: UTF-8

## 2. 通用说明

### 2.1 HTTP 方法

| 方法 | 说明 | 用途 |
|-----|------|------|
| GET | 获取资源 | 查询、健康检查 |
| POST | 创建资源 | 搜索(传递复杂参数) |

### 2.2 状态码

| 状态码 | 说明 |
|-------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 404 | 资源不找 |
| 422 | 数据验证失败 |
| 500 | 服务器内部错误 |
| 503 | 服务不可用 |

### 2.3 通用响应头

```
Content-Type: application/json; charset=utf-8
Access-Control-Allow-Origin: * (开发环境)
```

### 2.4 错误响应格式

```json
{
  "detail": "错误描述信息"
}
```

或 FastAPI 标准格式:
```json
{
  "detail": [
    {
      "loc": ["body", "query"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

## 3. API 接口详细说明

### 3.1 健康检查

#### 3.1.1 接口描述

检查 API 服务是否正常运行。

#### 3.1.2 接口信息

- **接口名称**: 健康检查
- **接口路径**: `/api/health`
- **请求方法**: GET
- **认证方式**: 无

#### 3.1.3 请求参数

无

#### 3.1.4 响应示例

**成功响应** (200 OK):
```json
{
  "ok": true
}
```

#### 3.1.5 代码示例

**cURL**:
```bash
curl -X GET "http://127.0.0.1:8000/api/health"
```

**JavaScript (fetch)**:
```javascript
const response = await fetch('http://127.0.0.1:8000/api/health')
const data = await response.json()
console.log(data)  // { ok: true }
```

**Python (httpx)**:
```python
import httpx

async with httpx.AsyncClient() as client:
    response = await client.get("http://127.0.0.1:8000/api/health")
    print(response.json())  # {'ok': True}
```

---

### 3.2 电影搜索(兼容接口)

#### 3.2.1 接口描述

兼容旧版 douban.py 的搜索接口,返回单个最佳匹配结果。

#### 3.2.2 接口信息

- **接口名称**: 电影搜索(兼容)
- **接口路径**: `/search`
- **请求方法**: GET
- **认证方式**: 无

#### 3.2.3 请求参数

**Query Parameters**:

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| keyword | string | 是 | 搜索关键词(文件名或电影名) | `White.House.Down.2013.1080p` |

#### 3.2.4 响应示例

**成功响应** (200 OK):
```json
{
  "fullname": "惊天危机 White House Down",
  "name": "惊天危机",
  "originalName": "White House Down",
  "year": 2013,
  "genre": "动作, 惊悚",
  "country": "美国",
  "alias": "白宫沦陷, White House Down"
}
```

**无结果** (200 OK):
```
""
```
(返回空字符串)

#### 3.2.5 字段说明

| 字段名 | 类型 | 说明 |
|-------|------|------|
| fullname | string | 完整名称(中英文组合) |
| name | string | 中文名称 |
| originalName | string | 英文原名 |
| year | integer | 上映年份 |
| genre | string | 类型,逗号分隔 |
| country | string | 制片国家/地区,逗号分隔 |
| alias | string | 别名,逗号分隔 |

#### 3.2.6 代码示例

**cURL**:
```bash
curl -X GET "http://127.0.0.1:8000/search?keyword=White.House.Down.2013.1080p"
```

**JavaScript**:
```javascript
const keyword = encodeURIComponent('White.House.Down.2013.1080p')
const response = await fetch(`http://127.0.0.1:8000/search?keyword=${keyword}`)
const data = await response.json()
console.log(data)
```

**Python**:
```python
import httpx

keyword = "White.House.Down.2013.1080p"
async with httpx.AsyncClient() as client:
    response = await client.get(
        "http://127.0.0.1:8000/search",
        params={"keyword": keyword}
    )
    print(response.json())
```

#### 3.2.7 注意事项

- 关键词会自动解析,提取电影名称和年份
- 如果包含年份,会优先返回年份匹配的结果
- 如果无结果,返回空字符串而非空对象

---

### 3.3 电影搜索(前端接口)

#### 3.3.1 接口描述

为前端提供的搜索接口,返回多个搜索结果,包含扩展信息(海报、维基链接等)。

#### 3.3.2 接口信息

- **接口名称**: 电影搜索(前端)
- **接口路径**: `/api/search`
- **请求方法**: POST
- **认证方式**: 无
- **Content-Type**: `application/json`

#### 3.3.3 请求参数

**Request Body (JSON)**:

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|-----|------|------|
| query | string | 是 | 搜索关键词 | `Inception 2010` |

**请求示例**:
```json
{
  "query": "White.House.Down.2013.1080p.BluRay.x264"
}
```

#### 3.3.4 响应示例

**成功响应** (200 OK):
```json
[
  {
    "wikidata_id": "Q227429",
    "title_cn": "惊天危机",
    "title_en": "White House Down",
    "year": 2013,
    "display_title": "惊天危机 White House Down (2013)",
    "genres": ["动作", "惊悚", "剧情"],
    "countries": ["美国"],
    "poster_url": "https://upload.wikimedia.org/wikipedia/en/thumb/1/15/White_House_Down_poster.jpg/220px-White_House_Down_poster.jpg",
    "wikipedia_links": {
      "zh": "https://zh.wikipedia.org/wiki/%E6%83%8A%E5%A4%A9%E5%8D%B1%E6%9C%BA",
      "en": "https://en.wikipedia.org/wiki/White_House_Down"
    }
  }
]
```

**无结果** (200 OK):
```json
[]
```

**请求参数错误** (422 Unprocessable Entity):
```json
{
  "detail": [
    {
      "loc": ["body", "query"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

#### 3.3.5 响应字段说明

| 字段名 | 类型 | 必填 | 说明 |
|-------|------|-----|------|
| wikidata_id | string | 否 | Wikidata 条目 ID,如 "Q227429" |
| title_cn | string | 否 | 中文标题 |
| title_en | string | 否 | 英文标题 |
| year | integer | 否 | 上映年份 |
| display_title | string | 是 | 用于显示的组合标题 |
| genres | array[string] | 是 | 类型标签列表 |
| countries | array[string] | 是 | 制片国家/地区列表 |
| poster_url | string | 否 | 海报图片 URL |
| wikipedia_links | object | 是 | 维基百科链接对象 |
| wikipedia_links.zh | string | 否 | 中文维基百科链接 |
| wikipedia_links.en | string | 否 | 英文维基百科链接 |

#### 3.3.6 代码示例

**cURL**:
```bash
curl -X POST "http://127.0.0.1:8000/api/search" \
  -H "Content-Type: application/json" \
  -d '{"query": "White House Down 2013"}'
```

**JavaScript (fetch)**:
```javascript
const searchMovie = async (query) => {
  const response = await fetch('http://127.0.0.1:8000/api/search', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ query }),
  })
  
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`)
  }
  
  const data = await response.json()
  return data
}

// 使用示例
try {
  const results = await searchMovie('Inception 2010')
  console.log(results)
} catch (error) {
  console.error('搜索失败:', error)
}
```

**JavaScript (axios)**:
```javascript
import axios from 'axios'

const searchMovie = async (query) => {
  try {
    const response = await axios.post('http://127.0.0.1:8000/api/search', {
      query: query
    })
    return response.data
  } catch (error) {
    console.error('搜索失败:', error.response?.data || error.message)
    throw error
  }
}
```

**Python (httpx)**:
```python
import httpx
import json

async def search_movie(query: str):
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "http://127.0.0.1:8000/api/search",
            json={"query": query},
            headers={"Content-Type": "application/json"}
        )
        response.raise_for_status()
        return response.json()

# 使用示例
import asyncio
results = asyncio.run(search_movie("Inception 2010"))
print(json.dumps(results, indent=2, ensure_ascii=False))
```

**Python (requests)**:
```python
import requests

def search_movie(query: str):
    response = requests.post(
        "http://127.0.0.1:8000/api/search",
        json={"query": query}
    )
    response.raise_for_status()
    return response.json()
```

#### 3.3.7 注意事项

1. **查询解析**: 系统会自动解析文件名,提取电影名称和年份
2. **年份过滤**: 如果查询中包含年份,会优先返回年份匹配的结果(±1年误差)
3. **结果限制**: 最多返回 5 个结果
4. **扩展信息**: 包含海报和维基百科链接,但可能为空
5. **超时**: 请求可能需要 2-5 秒,建议设置合理的超时时间

---

### 3.4 首页

#### 3.4.1 接口描述

简单的欢迎页面,用于确认服务正在运行。

#### 3.4.2 接口信息

- **接口路径**: `/` 或 `/index`
- **请求方法**: GET

#### 3.4.3 响应示例

```html
<html><body>Hello, This is CineSeek!</body></html>
```

---

## 4. 外部接口

### 4.1 Wikidata SPARQL 接口

CineSeek 后端依赖 Wikidata SPARQL 服务。

#### 4.1.1 接口信息

- **端点**: https://query.wikidata.org/sparql
- **方法**: GET/POST
- **格式**: SPARQL 查询语言

#### 4.1.2 查询示例

```sparql
SELECT DISTINCT ?item ?itemLabel ?year ?titleCN ?titleEN
WHERE {
  ?item wdt:P31 wd:Q11424 .  # 实例是电影
  
  {
    ?item rdfs:label ?titleCN .
    FILTER(LANG(?titleCN) = "zh" && REGEX(?titleCN, "盗梦空间", "i"))
  }
  UNION
  {
    ?item rdfs:label ?titleEN .
    FILTER(LANG(?titleEN) = "en" && REGEX(?titleEN, "Inception", "i"))
  }
  
  OPTIONAL { ?item wdt:P577 ?publicationDate . }
  BIND(YEAR(?publicationDate) AS ?year)
  
  SERVICE wikibase:label { bd:serviceParam wikibase:language "zh,en" . }
}
LIMIT 10
```

#### 4.1.3 重要属性

| Wikidata 属性 | 说明 |
|--------------|------|
| P31 | 实例(instance of) |
| P577 | 发行日期(publication date) |
| P136 | 类型(genre) |
| P495 | 原产国(country of origin) |
| P18 | 图像(image) |
| P1476 | 标题(title) |
| P2561 | 名称(name) |

---

## 5. 数据模型

### 5.1 SearchRequest

搜索请求模型。

```json
{
  "query": "string"
}
```

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| query | string | 是 | 搜索关键词 |

### 5.2 MovieResult

基础电影结果模型。

```json
{
  "fullname": "string",
  "name": "string",
  "originalName": "string",
  "year": 0,
  "genre": "string",
  "country": "string",
  "alias": "string"
}
```

### 5.3 MovieResultExtended

扩展电影结果模型。

```json
{
  "wikidata_id": "string or null",
  "title_cn": "string or null",
  "title_en": "string or null",
  "year": 0,
  "display_title": "string",
  "genres": ["string"],
  "countries": ["string"],
  "poster_url": "string or null",
  "wikipedia_links": {
    "zh": "string or null",
    "en": "string or null"
  }
}
```

---

## 6. 错误处理

### 6.1 常见错误

#### 6.1.1 参数缺失 (422)

**请求**:
```bash
curl -X POST "http://127.0.0.1:8000/api/search" \
  -H "Content-Type: application/json" \
  -d '{}'
```

**响应**:
```json
{
  "detail": [
    {
      "loc": ["body", "query"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

#### 6.1.2 服务不可用 (500)

当 Wikidata 服务不可用或网络错误时,可能返回 500 错误。

**响应**:
```json
{
  "detail": "Internal Server Error"
}
```

#### 6.1.3 超时

Wikidata 查询超时(15秒),会返回空结果而非错误。

---

## 7. 性能说明

### 7.1 响应时间

| 接口 | 平均响应时间 | 说明 |
|-----|------------|------|
| /api/health | < 50ms | 无外部依赖 |
| /search | 2-5s | 依赖 Wikidata SPARQL |
| /api/search | 2-5s | 依赖 Wikidata SPARQL |

### 7.2 限制

- **并发**: 支持 100+ 并发请求
- **超时**: Wikidata 查询 15 秒超时
- **结果数量**: 最多返回 5 个结果(前端接口)

---

## 8. 版本控制

### 8.1 API 版本

当前版本: **v0.1.0**

### 8.2 兼容性

- `/search` 接口保持向后兼容
- `/api/search` 为新版接口,推荐使用

### 8.3 变更日志

| 版本 | 日期 | 变更内容 |
|-----|------|---------|
| v0.1.0 | 2025-11-02 | 初始版本发布 |

---

## 9. 附录

### 9.1 完整示例

#### Vue 3 前端集成示例

```vue
<script setup>
import { ref } from 'vue'

const API_BASE = 'http://127.0.0.1:8000'
const query = ref('')
const results = ref([])
const loading = ref(false)
const error = ref('')

async function search() {
  if (!query.value.trim()) return
  
  loading.value = true
  error.value = ''
  results.value = []
  
  try {
    const response = await fetch(`${API_BASE}/api/search`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: query.value }),
    })
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`)
    }
    
    results.value = await response.json()
  } catch (e) {
    error.value = e.message
  } finally {
    loading.value = false
  }
}
</script>

<template>
  <div>
    <input v-model="query" @keyup.enter="search" />
    <button @click="search" :disabled="loading">搜索</button>
    
    <div v-if="error" class="error">{{ error }}</div>
    
    <div v-for="movie in results" :key="movie.wikidata_id">
      <h3>{{ movie.display_title }}</h3>
      <img :src="movie.poster_url" />
      <p>类型: {{ movie.genres.join(', ') }}</p>
      <p>国家: {{ movie.countries.join(', ') }}</p>
    </div>
  </div>
</template>
```

#### Python 批量查询示例

```python
import asyncio
import httpx

async def batch_search(queries: list[str]):
    """批量搜索电影"""
    async with httpx.AsyncClient() as client:
        tasks = [
            client.post(
                "http://127.0.0.1:8000/api/search",
                json={"query": q},
                timeout=30.0
            )
            for q in queries
        ]
        
        responses = await asyncio.gather(*tasks, return_exceptions=True)
        
        results = []
        for i, resp in enumerate(responses):
            if isinstance(resp, Exception):
                print(f"Query '{queries[i]}' failed: {resp}")
                results.append([])
            else:
                results.append(resp.json())
        
        return results

# 使用示例
queries = [
    "Inception 2010",
    "The Matrix 1999",
    "Interstellar 2014"
]

results = asyncio.run(batch_search(queries))
for query, movies in zip(queries, results):
    print(f"\n{query}:")
    for movie in movies:
        print(f"  - {movie['display_title']}")
```

### 9.2 Postman Collection

可以导入以下 JSON 到 Postman:

```json
{
  "info": {
    "name": "CineSeek API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "健康检查",
      "request": {
        "method": "GET",
        "url": "{{base_url}}/api/health"
      }
    },
    {
      "name": "电影搜索(前端)",
      "request": {
        "method": "POST",
        "url": "{{base_url}}/api/search",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"query\": \"Inception 2010\"\n}"
        }
      }
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "http://127.0.0.1:8000"
    }
  ]
}
```

---

**文档状态**: ✅ 已完成  
**最后更新**: 2025-11-02  
**版本历史**: v1.0 - 初始版本
